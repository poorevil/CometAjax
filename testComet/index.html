<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Chat</title>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
	<script src="http://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
    
	<script type="text/javascript">
	var uuid = "{{uuid}}";
	var requestCount = 0;

	function resetQRCode(){
		location.reload();
	}

	var _nAjaxTimeout = 5 * 10000;
	//获取登录结果，长连接
	var watchDog = function(){
		if (requestCount == 30) {
			resetQRCode();
		}

		requestCount++;

		$.ajax({
			type: "GET",
			url:"/loginresult/"+uuid+"/",
			dataType: "json",
			cache: false,
			timeout: _nAjaxTimeout,
			success: function(data, textStatus, jqXHR) {
				// alert(eval(data["result_code"])+data["msg"]);
				// alert(textStatus);
				// alert(eval(jqXHR));

				switch(data["result_code"]){
					case 208://get result！！
						alert("result_code: "+eval(data["result_code"])+"     msg: "+data["msg"]);
						break;
					case 408://time out
					default:
						setTimeout(watchDog(),500);
						break;
				}
			},
			error: function(jqXHR, textStatus, errorThrown) {
				// alert(textStatus);
				setTimeout(watchDog(),500);
			}
		});
	};

	//获取二维码
	var requestQRCode = function(){
		watchDog();

		$.ajax({
			type: "GET",
			url:"/renderQRCode/"+uuid+"/",
			dataType: "text",
			cache: false,
			timeout: _nAjaxTimeout,
			success: function(data, textStatus, jqXHR) {
				
				// $("#qrcode").css("visibility","hidden");
				$("#qrcode").attr('src',data);
				$("#qrcode").delay(200).fadeIn();

			},
			error: function(jqXHR, textStatus, errorThrown) {
				alert(textStatus);
			}
		});

	};
	$(document).ready(requestQRCode);

	</script>


  </head>
  <body>
  	<img src="" id="qrcode" width="220" height="220"/>
  </body>
</html>